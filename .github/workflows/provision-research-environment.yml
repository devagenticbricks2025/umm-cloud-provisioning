# .github/workflows/provision-research-environment.yml
# Unified workflow for Research Computing Services
# Handles both Standard Research and PHI/AVE environments

name: Provision Research Environment

on:
  # Triggered by ServiceNow webhook
  repository_dispatch:
    types: [provision-research-environment]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      ticket_number:
        description: 'ServiceNow Ticket Number'
        required: true
        type: string
      request_type:
        description: 'Request Type'
        required: true
        type: choice
        options:
          - standard_research
          - phi_ave
      project_name:
        description: 'Research Project Name'
        required: true
        type: string
      principal_investigator:
        description: 'PI Email'
        required: true
        type: string
      department:
        description: 'Department'
        required: false
        type: string
        default: 'research'
      cost_center:
        description: 'Cost Center / Grant Code'
        required: true
        type: string
      workload_types:
        description: 'Workload Types (comma-separated: statistical,imaging,ml,data_prep)'
        required: false
        type: string
        default: 'general'
      # PHI-specific inputs
      irb_number:
        description: 'IRB Number (PHI only)'
        required: false
        type: string
      access_method:
        description: 'Access Method (PHI only)'
        required: false
        type: choice
        options:
          - remote_desktop
          - analytics_workspace
          - both
      expected_duration:
        description: 'Expected Duration (PHI only)'
        required: false
        type: choice
        options:
          - 3_months
          - 6_months
          - 12_months
          - 24_months

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  TF_VAR_location: "eastus"

jobs:
  # ============================================
  # JOB 1: Parse and Validate Request
  # ============================================
  parse-request:
    name: Parse Request
    runs-on: ubuntu-latest
    outputs:
      ticket_number: ${{ steps.parse.outputs.ticket_number }}
      request_type: ${{ steps.parse.outputs.request_type }}
      project_name: ${{ steps.parse.outputs.project_name }}
      resource_suffix: ${{ steps.resource.outputs.resource_suffix }}
      principal_investigator: ${{ steps.parse.outputs.principal_investigator }}
      department: ${{ steps.parse.outputs.department }}
      cost_center: ${{ steps.parse.outputs.cost_center }}
      workload_types: ${{ steps.parse.outputs.workload_types }}
      environment: ${{ steps.parse.outputs.environment }}
      security_level: ${{ steps.parse.outputs.security_level }}
      expected_end_date: ${{ steps.parse.outputs.expected_end_date }}
      # PHI-specific
      irb_number: ${{ steps.parse.outputs.irb_number }}
      access_method: ${{ steps.parse.outputs.access_method }}
      expected_duration: ${{ steps.parse.outputs.expected_duration }}
      data_retention: ${{ steps.parse.outputs.data_retention }}

    steps:
      - name: Parse Request Data
        id: parse
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "Source: ServiceNow Webhook"
            PAYLOAD='${{ toJson(github.event.client_payload) }}'

            # Common fields
            echo "ticket_number=$(echo $PAYLOAD | jq -r '.ticket_number // \"UNKNOWN\"')" >> $GITHUB_OUTPUT
            echo "request_type=$(echo $PAYLOAD | jq -r '.request_type // \"standard_research\"')" >> $GITHUB_OUTPUT
            echo "project_name=$(echo $PAYLOAD | jq -r '.project_name // \"research-project\"')" >> $GITHUB_OUTPUT
            echo "principal_investigator=$(echo $PAYLOAD | jq -r '.principal_investigator // \"unknown@umich.edu\"')" >> $GITHUB_OUTPUT
            echo "department=$(echo $PAYLOAD | jq -r '.department // \"research\"')" >> $GITHUB_OUTPUT
            echo "cost_center=$(echo $PAYLOAD | jq -r '.cost_center // \"CC-DEFAULT\"')" >> $GITHUB_OUTPUT
            echo "workload_types=$(echo $PAYLOAD | jq -r '.workload_types // \"general\"')" >> $GITHUB_OUTPUT
            echo "environment=$(echo $PAYLOAD | jq -r '.environment // \"dev\"')" >> $GITHUB_OUTPUT
            echo "security_level=$(echo $PAYLOAD | jq -r '.security_level // \"standard\"')" >> $GITHUB_OUTPUT
            echo "expected_end_date=$(echo $PAYLOAD | jq -r '.expected_end_date // \"\"')" >> $GITHUB_OUTPUT

            # PHI-specific fields
            echo "irb_number=$(echo $PAYLOAD | jq -r '.irb_number // \"\"')" >> $GITHUB_OUTPUT
            echo "access_method=$(echo $PAYLOAD | jq -r '.access_method // \"remote_desktop\"')" >> $GITHUB_OUTPUT
            echo "expected_duration=$(echo $PAYLOAD | jq -r '.expected_duration // \"6_months\"')" >> $GITHUB_OUTPUT
            echo "data_retention=$(echo $PAYLOAD | jq -r '.data_retention // \"90_days\"')" >> $GITHUB_OUTPUT

          else
            echo "Source: Manual Workflow Dispatch"
            echo "ticket_number=${{ inputs.ticket_number }}" >> $GITHUB_OUTPUT
            echo "request_type=${{ inputs.request_type }}" >> $GITHUB_OUTPUT
            echo "project_name=${{ inputs.project_name }}" >> $GITHUB_OUTPUT
            echo "principal_investigator=${{ inputs.principal_investigator }}" >> $GITHUB_OUTPUT
            echo "department=${{ inputs.department }}" >> $GITHUB_OUTPUT
            echo "cost_center=${{ inputs.cost_center }}" >> $GITHUB_OUTPUT
            echo "workload_types=${{ inputs.workload_types }}" >> $GITHUB_OUTPUT
            echo "expected_end_date=" >> $GITHUB_OUTPUT

            # Set environment based on request type
            if [ "${{ inputs.request_type }}" == "phi_ave" ]; then
              echo "environment=prod" >> $GITHUB_OUTPUT
              echo "security_level=hipaa" >> $GITHUB_OUTPUT
            else
              echo "environment=dev" >> $GITHUB_OUTPUT
              echo "security_level=standard" >> $GITHUB_OUTPUT
            fi

            echo "irb_number=${{ inputs.irb_number }}" >> $GITHUB_OUTPUT
            echo "access_method=${{ inputs.access_method || 'both' }}" >> $GITHUB_OUTPUT
            echo "expected_duration=${{ inputs.expected_duration || '6_months' }}" >> $GITHUB_OUTPUT
            echo "data_retention=90_days" >> $GITHUB_OUTPUT
          fi

      - name: Generate Resource Suffix
        id: resource
        run: |
          # Create sanitized resource suffix from project name
          PROJECT="${{ steps.parse.outputs.project_name }}"
          # Convert to lowercase, replace spaces with hyphens, remove special chars
          RESOURCE_NAME=$(echo "$PROJECT" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-' | cut -c1-16)
          # Add random suffix for uniqueness
          SUFFIX=$(echo $RANDOM | md5sum | head -c 4)
          echo "resource_suffix=${RESOURCE_NAME}-${SUFFIX}" >> $GITHUB_OUTPUT

      - name: Display Request Summary
        run: |
          echo "======================================================"
          echo "         RESEARCH ENVIRONMENT REQUEST                 "
          echo "======================================================"
          echo " Ticket:       ${{ steps.parse.outputs.ticket_number }}"
          echo " Type:         ${{ steps.parse.outputs.request_type }}"
          echo " Project:      ${{ steps.parse.outputs.project_name }}"
          echo " Resource:     ${{ steps.resource.outputs.resource_suffix }}"
          echo " PI:           ${{ steps.parse.outputs.principal_investigator }}"
          echo " Department:   ${{ steps.parse.outputs.department }}"
          echo " Cost Center:  ${{ steps.parse.outputs.cost_center }}"
          echo " Environment:  ${{ steps.parse.outputs.environment }}"
          echo " Security:     ${{ steps.parse.outputs.security_level }}"
          if [ "${{ steps.parse.outputs.request_type }}" == "phi_ave" ]; then
            echo "------------------------------------------------------"
            echo " PHI/AVE SPECIFIC:"
            echo " IRB Number:   ${{ steps.parse.outputs.irb_number }}"
            echo " Access:       ${{ steps.parse.outputs.access_method }}"
            echo " Duration:     ${{ steps.parse.outputs.expected_duration }}"
            echo " Retention:    ${{ steps.parse.outputs.data_retention }}"
          else
            echo "------------------------------------------------------"
            echo " STANDARD RESEARCH SPECIFIC:"
            echo " Workloads:    ${{ steps.parse.outputs.workload_types }}"
          fi
          echo "======================================================"

  # ============================================
  # JOB 2: Update ServiceNow - Started
  # ============================================
  notify-started:
    name: Notify Started
    needs: parse-request
    runs-on: ubuntu-latest
    steps:
      - name: Update ServiceNow - Provisioning Started
        continue-on-error: true
        run: |
          REQUEST_TYPE="${{ needs.parse-request.outputs.request_type }}"
          if [ "$REQUEST_TYPE" == "phi_ave" ]; then
            MSG="Secure PHI Environment (AVE) provisioning started. This includes HIPAA-compliant infrastructure with network isolation, encryption, audit logging, and Defender for Cloud monitoring. Estimated time: 15-30 minutes. Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            MSG="Standard Research Computing environment provisioning started. Estimated time: 10-15 minutes. Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          if [ -n "${{ secrets.SERVICENOW_INSTANCE }}" ]; then
            curl -s -X PATCH \
              -u "${{ secrets.SERVICENOW_USER }}:${{ secrets.SERVICENOW_PASSWORD }}" \
              -H "Content-Type: application/json" \
              -d "{\"work_notes\": \"$MSG\"}" \
              "https://${{ secrets.SERVICENOW_INSTANCE }}.service-now.com/api/now/table/sc_req_item?sysparm_query=number=${{ needs.parse-request.outputs.ticket_number }}"
          fi

  # ============================================
  # JOB 3: Provision Environment (Unified)
  # ============================================
  provision:
    name: Provision ${{ needs.parse-request.outputs.request_type == 'phi_ave' && 'PHI/AVE' || 'Standard Research' }} Environment
    needs: [parse-request, notify-started]
    runs-on: ubuntu-latest
    outputs:
      resource_group: ${{ steps.outputs.outputs.resource_group }}
      connection_info: ${{ steps.outputs.outputs.connection_info }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        working-directory: ./terraform/environments/dev
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ needs.parse-request.outputs.request_type }}-${{ needs.parse-request.outputs.resource_suffix }}.tfstate"

      - name: Terraform Plan
        working-directory: ./terraform/environments/dev
        run: |
          terraform plan \
            -var="request_type=${{ needs.parse-request.outputs.request_type }}" \
            -var="project_name=${{ needs.parse-request.outputs.project_name }}" \
            -var="resource_suffix=${{ needs.parse-request.outputs.resource_suffix }}" \
            -var="ticket_number=${{ needs.parse-request.outputs.ticket_number }}" \
            -var="principal_investigator=${{ needs.parse-request.outputs.principal_investigator }}" \
            -var="department=${{ needs.parse-request.outputs.department }}" \
            -var="cost_center=${{ needs.parse-request.outputs.cost_center }}" \
            -var="workload_types=${{ needs.parse-request.outputs.workload_types }}" \
            -var="expected_end_date=${{ needs.parse-request.outputs.expected_end_date }}" \
            -var="irb_number=${{ needs.parse-request.outputs.irb_number }}" \
            -var="access_method=${{ needs.parse-request.outputs.access_method }}" \
            -var="expected_duration=${{ needs.parse-request.outputs.expected_duration }}" \
            -var="data_retention=${{ needs.parse-request.outputs.data_retention }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform/environments/dev
        run: terraform apply -auto-approve tfplan

      - name: Get Outputs
        id: outputs
        working-directory: ./terraform/environments/dev
        run: |
          echo "resource_group=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT

          # Get connection info as JSON
          CONNECTION_INFO=$(terraform output -json connection_info)
          echo "connection_info<<EOF" >> $GITHUB_OUTPUT
          echo "$CONNECTION_INFO" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Display Provisioning Results
        working-directory: ./terraform/environments/dev
        run: |
          echo "======================================================"
          echo "         PROVISIONING COMPLETE                        "
          echo "======================================================"
          echo ""
          echo "Request Type: ${{ needs.parse-request.outputs.request_type }}"
          echo "Resource Group: $(terraform output -raw resource_group_name)"
          echo ""
          echo "Connection Information:"
          terraform output -json connection_info | jq '.'
          echo ""
          echo "Security Summary:"
          terraform output -json security_summary | jq '.'
          echo ""
          echo "Environment Summary:"
          terraform output -json environment_summary | jq '.'
          echo "======================================================"

  # ============================================
  # JOB 4: Update ServiceNow - Success
  # ============================================
  notify-success:
    name: Notify Success
    needs: [parse-request, provision]
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Build Success Message
        id: message
        run: |
          REQUEST_TYPE="${{ needs.parse-request.outputs.request_type }}"
          RG="${{ needs.provision.outputs.resource_group }}"

          if [ "$REQUEST_TYPE" == "standard_research" ]; then
            MSG="SUCCESS: Standard Research Environment Ready!

Environment Details:
- Resource Group: $RG
- Project: ${{ needs.parse-request.outputs.project_name }}
- Workloads: ${{ needs.parse-request.outputs.workload_types }}

Access Instructions:
Connection details have been sent to ${{ needs.parse-request.outputs.principal_investigator }}

Estimated Monthly Cost: \$350-\$650
Cost Center: ${{ needs.parse-request.outputs.cost_center }}

Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          elif [ "$REQUEST_TYPE" == "phi_ave" ]; then
            MSG="SUCCESS: Secure PHI Environment (AVE) Ready!

HIPAA-compliant environment provisioned.

Environment Details:
- Resource Group: $RG
- Project: ${{ needs.parse-request.outputs.project_name }}
- IRB: ${{ needs.parse-request.outputs.irb_number }}
- Duration: ${{ needs.parse-request.outputs.expected_duration }}

Security Features Enabled:
- Network isolation (no public IP)
- Encryption at rest (Customer-managed key)
- Encryption in transit (TLS 1.2)
- Audit logging (Log Analytics)
- HIPAA/HITRUST policy applied
- Azure Bastion for secure access

Access Instructions:
All access is via Azure Bastion only. Contact the PI for access coordination.

Estimated Monthly Cost: \$4,200-\$8,500
Cost Center: ${{ needs.parse-request.outputs.cost_center }}

Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          # Save to file for proper escaping
          echo "$MSG" > /tmp/message.txt

      - name: Update ServiceNow - Success
        continue-on-error: true
        run: |
          MSG=$(cat /tmp/message.txt | jq -Rs .)

          if [ -n "${{ secrets.SERVICENOW_INSTANCE }}" ]; then
            curl -s -X PATCH \
              -u "${{ secrets.SERVICENOW_USER }}:${{ secrets.SERVICENOW_PASSWORD }}" \
              -H "Content-Type: application/json" \
              -d "{\"state\": \"3\", \"work_notes\": $MSG}" \
              "https://${{ secrets.SERVICENOW_INSTANCE }}.service-now.com/api/now/table/sc_req_item?sysparm_query=number=${{ needs.parse-request.outputs.ticket_number }}"
          fi

  # ============================================
  # JOB 5: Update ServiceNow - Failure
  # ============================================
  notify-failure:
    name: Notify Failure
    needs: [parse-request, provision]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Update ServiceNow - Failure
        continue-on-error: true
        run: |
          MSG="FAILED: Provisioning Failed

Request Type: ${{ needs.parse-request.outputs.request_type }}
Project: ${{ needs.parse-request.outputs.project_name }}

Please review the GitHub Actions logs for details:
${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

Contact the Cloud Team for assistance."

          MSG_JSON=$(echo "$MSG" | jq -Rs .)

          if [ -n "${{ secrets.SERVICENOW_INSTANCE }}" ]; then
            curl -s -X PATCH \
              -u "${{ secrets.SERVICENOW_USER }}:${{ secrets.SERVICENOW_PASSWORD }}" \
              -H "Content-Type: application/json" \
              -d "{\"state\": \"4\", \"work_notes\": $MSG_JSON}" \
              "https://${{ secrets.SERVICENOW_INSTANCE }}.service-now.com/api/now/table/sc_req_item?sysparm_query=number=${{ needs.parse-request.outputs.ticket_number }}"
          fi
