# .github/workflows/provision-research-environment.yml
# Unified workflow for Research Computing Services
# Handles both Standard Research and PHI/AVE environments

name: Provision Research Environment

on:
  # Triggered by ServiceNow webhook
  repository_dispatch:
    types: [provision-research-environment]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      ticket_number:
        description: 'ServiceNow Ticket Number'
        required: true
        type: string
      request_type:
        description: 'Request Type'
        required: true
        type: choice
        options:
          - standard_research
          - phi_ave
      project_name:
        description: 'Research Project Name'
        required: true
        type: string
      principal_investigator:
        description: 'PI Email'
        required: true
        type: string
      department:
        description: 'Department'
        required: false
        type: string
        default: 'research'
      cost_center:
        description: 'Cost Center / Grant Code'
        required: true
        type: string
      workload_types:
        description: 'Workload Types (comma-separated: statistical,imaging,ml,data_prep)'
        required: false
        type: string
        default: 'general'
      # PHI-specific inputs
      irb_number:
        description: 'IRB Number (PHI only)'
        required: false
        type: string
      access_method:
        description: 'Access Method (PHI only)'
        required: false
        type: choice
        options:
          - remote_desktop
          - analytics_workspace
          - both
      expected_duration:
        description: 'Expected Duration (PHI only)'
        required: false
        type: choice
        options:
          - 3_months
          - 6_months
          - 12_months
          - 24_months

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  TF_VAR_location: "northeurope"

jobs:
  # ============================================
  # JOB 1: Parse and Validate Request
  # ============================================
  parse-request:
    name: Parse Request
    runs-on: ubuntu-latest
    outputs:
      ticket_number: ${{ steps.parse.outputs.ticket_number }}
      request_type: ${{ steps.parse.outputs.request_type }}
      project_name: ${{ steps.parse.outputs.project_name }}
      resource_suffix: ${{ steps.resource.outputs.resource_suffix }}
      principal_investigator: ${{ steps.parse.outputs.principal_investigator }}
      department: ${{ steps.parse.outputs.department }}
      cost_center: ${{ steps.parse.outputs.cost_center }}
      workload_types: ${{ steps.parse.outputs.workload_types }}
      environment: ${{ steps.parse.outputs.environment }}
      security_level: ${{ steps.parse.outputs.security_level }}
      expected_end_date: ${{ steps.parse.outputs.expected_end_date }}
      # PHI-specific
      irb_number: ${{ steps.parse.outputs.irb_number }}
      access_method: ${{ steps.parse.outputs.access_method }}
      expected_duration: ${{ steps.parse.outputs.expected_duration }}
      data_retention: ${{ steps.parse.outputs.data_retention }}

    steps:
      - name: Parse Request Data
        id: parse
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "Source: ServiceNow Webhook"
            PAYLOAD='${{ toJson(github.event.client_payload) }}'

            # Common fields - parse each separately to avoid quoting issues
            TICKET=$(echo "$PAYLOAD" | jq -r '.ticket_number // "UNKNOWN"')
            REQUEST_TYPE=$(echo "$PAYLOAD" | jq -r '.request_type // "standard_research"')
            PROJECT=$(echo "$PAYLOAD" | jq -r '.project_name // "research-project"')
            PI=$(echo "$PAYLOAD" | jq -r '.principal_investigator // "unknown@umich.edu"')
            DEPT=$(echo "$PAYLOAD" | jq -r '.department // "research"')
            COST=$(echo "$PAYLOAD" | jq -r '.cost_center // "CC-DEFAULT"')
            WORKLOADS=$(echo "$PAYLOAD" | jq -r '.workload_types // "general"')
            ENV=$(echo "$PAYLOAD" | jq -r '.environment // "dev"')
            SECURITY=$(echo "$PAYLOAD" | jq -r '.security_level // "standard"')
            END_DATE=$(echo "$PAYLOAD" | jq -r '.expected_end_date // ""')

            # PHI-specific fields
            IRB=$(echo "$PAYLOAD" | jq -r '.irb_number // ""')
            ACCESS=$(echo "$PAYLOAD" | jq -r '.access_method // "remote_desktop"')
            DURATION=$(echo "$PAYLOAD" | jq -r '.expected_duration // "6_months"')
            RETENTION=$(echo "$PAYLOAD" | jq -r '.data_retention // "90_days"')

            # Write to outputs
            echo "ticket_number=$TICKET" >> $GITHUB_OUTPUT
            echo "request_type=$REQUEST_TYPE" >> $GITHUB_OUTPUT
            echo "project_name=$PROJECT" >> $GITHUB_OUTPUT
            echo "principal_investigator=$PI" >> $GITHUB_OUTPUT
            echo "department=$DEPT" >> $GITHUB_OUTPUT
            echo "cost_center=$COST" >> $GITHUB_OUTPUT
            echo "workload_types=$WORKLOADS" >> $GITHUB_OUTPUT
            echo "environment=$ENV" >> $GITHUB_OUTPUT
            echo "security_level=$SECURITY" >> $GITHUB_OUTPUT
            echo "expected_end_date=$END_DATE" >> $GITHUB_OUTPUT
            echo "irb_number=$IRB" >> $GITHUB_OUTPUT
            echo "access_method=$ACCESS" >> $GITHUB_OUTPUT
            echo "expected_duration=$DURATION" >> $GITHUB_OUTPUT
            echo "data_retention=$RETENTION" >> $GITHUB_OUTPUT

          else
            echo "Source: Manual Workflow Dispatch"
            echo "ticket_number=${{ inputs.ticket_number }}" >> $GITHUB_OUTPUT
            echo "request_type=${{ inputs.request_type }}" >> $GITHUB_OUTPUT
            echo "project_name=${{ inputs.project_name }}" >> $GITHUB_OUTPUT
            echo "principal_investigator=${{ inputs.principal_investigator }}" >> $GITHUB_OUTPUT
            echo "department=${{ inputs.department }}" >> $GITHUB_OUTPUT
            echo "cost_center=${{ inputs.cost_center }}" >> $GITHUB_OUTPUT
            echo "workload_types=${{ inputs.workload_types }}" >> $GITHUB_OUTPUT
            echo "expected_end_date=" >> $GITHUB_OUTPUT

            # Set environment based on request type
            if [ "${{ inputs.request_type }}" == "phi_ave" ]; then
              echo "environment=prod" >> $GITHUB_OUTPUT
              echo "security_level=hipaa" >> $GITHUB_OUTPUT
            else
              echo "environment=dev" >> $GITHUB_OUTPUT
              echo "security_level=standard" >> $GITHUB_OUTPUT
            fi

            echo "irb_number=${{ inputs.irb_number }}" >> $GITHUB_OUTPUT
            echo "access_method=${{ inputs.access_method || 'both' }}" >> $GITHUB_OUTPUT
            echo "expected_duration=${{ inputs.expected_duration || '6_months' }}" >> $GITHUB_OUTPUT
            echo "data_retention=90_days" >> $GITHUB_OUTPUT
          fi

      - name: Generate Resource Suffix
        id: resource
        run: |
          # Create sanitized resource suffix from project name
          PROJECT="${{ steps.parse.outputs.project_name }}"
          # Convert to lowercase, replace spaces with hyphens, remove special chars
          RESOURCE_NAME=$(echo "$PROJECT" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-' | cut -c1-16)
          # Add random suffix for uniqueness
          SUFFIX=$(echo $RANDOM | md5sum | head -c 4)
          echo "resource_suffix=${RESOURCE_NAME}-${SUFFIX}" >> $GITHUB_OUTPUT

      - name: Display Request Summary
        run: |
          echo "======================================================"
          echo "         RESEARCH ENVIRONMENT REQUEST                 "
          echo "======================================================"
          echo " Ticket:       ${{ steps.parse.outputs.ticket_number }}"
          echo " Type:         ${{ steps.parse.outputs.request_type }}"
          echo " Project:      ${{ steps.parse.outputs.project_name }}"
          echo " Resource:     ${{ steps.resource.outputs.resource_suffix }}"
          echo " PI:           ${{ steps.parse.outputs.principal_investigator }}"
          echo " Department:   ${{ steps.parse.outputs.department }}"
          echo " Cost Center:  ${{ steps.parse.outputs.cost_center }}"
          echo " Environment:  ${{ steps.parse.outputs.environment }}"
          echo " Security:     ${{ steps.parse.outputs.security_level }}"
          if [ "${{ steps.parse.outputs.request_type }}" == "phi_ave" ]; then
            echo "------------------------------------------------------"
            echo " PHI/AVE SPECIFIC:"
            echo " IRB Number:   ${{ steps.parse.outputs.irb_number }}"
            echo " Access:       ${{ steps.parse.outputs.access_method }}"
            echo " Duration:     ${{ steps.parse.outputs.expected_duration }}"
            echo " Retention:    ${{ steps.parse.outputs.data_retention }}"
          else
            echo "------------------------------------------------------"
            echo " STANDARD RESEARCH SPECIFIC:"
            echo " Workloads:    ${{ steps.parse.outputs.workload_types }}"
          fi
          echo "======================================================"

  # ============================================
  # JOB 2: Update ServiceNow - Started
  # ============================================
  notify-started:
    name: Notify Started
    needs: parse-request
    runs-on: ubuntu-latest
    steps:
      - name: Update ServiceNow - Provisioning Started
        continue-on-error: true
        run: |
          REQUEST_TYPE="${{ needs.parse-request.outputs.request_type }}"
          if [ "$REQUEST_TYPE" == "phi_ave" ]; then
            MSG="Secure PHI Environment (AVE) provisioning started. This includes HIPAA-compliant infrastructure with network isolation, encryption, audit logging, and Defender for Cloud monitoring. Estimated time: 15-30 minutes. Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            MSG="Standard Research Computing environment provisioning started. Estimated time: 10-15 minutes. Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          if [ -n "${{ secrets.SERVICENOW_INSTANCE }}" ]; then
            curl -s -X PATCH \
              -u "${{ secrets.SERVICENOW_USER }}:${{ secrets.SERVICENOW_PASSWORD }}" \
              -H "Content-Type: application/json" \
              -d "{\"work_notes\": \"$MSG\"}" \
              "https://${{ secrets.SERVICENOW_INSTANCE }}.service-now.com/api/now/table/sc_req_item?sysparm_query=number=${{ needs.parse-request.outputs.ticket_number }}"
          fi

  # ============================================
  # JOB 3: Provision Environment (Unified)
  # ============================================
  provision:
    name: Provision ${{ needs.parse-request.outputs.request_type == 'phi_ave' && 'PHI/AVE' || 'Standard Research' }} Environment
    needs: [parse-request, notify-started]
    runs-on: ubuntu-latest
    outputs:
      resource_group: ${{ steps.outputs.outputs.resource_group }}
      vm_name: ${{ steps.outputs.outputs.vm_name }}
      public_ip: ${{ steps.outputs.outputs.public_ip }}
      storage_account: ${{ steps.outputs.outputs.storage_account }}
      subscription_id: ${{ steps.outputs.outputs.subscription_id }}
      connection_info: ${{ steps.outputs.outputs.connection_info }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        working-directory: ./terraform/environments/dev
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ needs.parse-request.outputs.request_type }}-${{ needs.parse-request.outputs.resource_suffix }}.tfstate"

      - name: Terraform Plan
        working-directory: ./terraform/environments/dev
        run: |
          terraform plan \
            -var="request_type=${{ needs.parse-request.outputs.request_type }}" \
            -var="project_name=${{ needs.parse-request.outputs.project_name }}" \
            -var="resource_suffix=${{ needs.parse-request.outputs.resource_suffix }}" \
            -var="ticket_number=${{ needs.parse-request.outputs.ticket_number }}" \
            -var="principal_investigator=${{ needs.parse-request.outputs.principal_investigator }}" \
            -var="department=${{ needs.parse-request.outputs.department }}" \
            -var="cost_center=${{ needs.parse-request.outputs.cost_center }}" \
            -var="workload_types=${{ needs.parse-request.outputs.workload_types }}" \
            -var="expected_end_date=${{ needs.parse-request.outputs.expected_end_date }}" \
            -var="irb_number=${{ needs.parse-request.outputs.irb_number }}" \
            -var="access_method=${{ needs.parse-request.outputs.access_method }}" \
            -var="expected_duration=${{ needs.parse-request.outputs.expected_duration }}" \
            -var="data_retention=${{ needs.parse-request.outputs.data_retention }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform/environments/dev
        run: terraform apply -auto-approve tfplan

      - name: Get Outputs
        id: outputs
        working-directory: ./terraform/environments/dev
        run: |
          # Get resource group name
          RG_NAME=$(terraform output -raw resource_group_name 2>/dev/null || echo "")
          echo "resource_group=$RG_NAME" >> $GITHUB_OUTPUT

          # Get VM name
          VM_NAME=$(terraform output -raw vm_name 2>/dev/null || echo "")
          echo "vm_name=$VM_NAME" >> $GITHUB_OUTPUT

          # Get public IP
          PUBLIC_IP=$(terraform output -raw public_ip 2>/dev/null || echo "N/A")
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT

          # Get storage account name
          STORAGE_NAME=$(terraform output -raw storage_account_name 2>/dev/null || echo "")
          echo "storage_account=$STORAGE_NAME" >> $GITHUB_OUTPUT

          # Get connection info as JSON
          CONNECTION_INFO=$(terraform output -json connection_info 2>/dev/null || echo "{}")
          echo "connection_info<<EOF" >> $GITHUB_OUTPUT
          echo "$CONNECTION_INFO" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get subscription ID for portal URLs
          SUBSCRIPTION_ID="${ARM_SUBSCRIPTION_ID}"
          echo "subscription_id=$SUBSCRIPTION_ID" >> $GITHUB_OUTPUT

      - name: Display Provisioning Results
        working-directory: ./terraform/environments/dev
        run: |
          echo "======================================================"
          echo "         PROVISIONING COMPLETE                        "
          echo "======================================================"
          echo ""
          echo "Request Type: ${{ needs.parse-request.outputs.request_type }}"
          echo "Resource Group: $(terraform output -raw resource_group_name)"
          echo ""
          echo "Connection Information:"
          terraform output -json connection_info | jq '.'
          echo ""
          echo "Security Summary:"
          terraform output -json security_summary | jq '.'
          echo ""
          echo "Environment Summary:"
          terraform output -json environment_summary | jq '.'
          echo "======================================================"

  # ============================================
  # JOB 4: Update ServiceNow - Success
  # ============================================
  notify-success:
    name: Notify Success
    needs: [parse-request, provision]
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Build Success Message
        id: message
        env:
          REQUEST_TYPE: ${{ needs.parse-request.outputs.request_type }}
          RG: ${{ needs.provision.outputs.resource_group }}
          VM_NAME: ${{ needs.provision.outputs.vm_name }}
          PUBLIC_IP: ${{ needs.provision.outputs.public_ip }}
          STORAGE_ACCOUNT: ${{ needs.provision.outputs.storage_account }}
          SUBSCRIPTION_ID: ${{ needs.provision.outputs.subscription_id }}
          PROJECT: ${{ needs.parse-request.outputs.project_name }}
          WORKLOADS: ${{ needs.parse-request.outputs.workload_types }}
          PI: ${{ needs.parse-request.outputs.principal_investigator }}
          COST_CENTER: ${{ needs.parse-request.outputs.cost_center }}
          IRB: ${{ needs.parse-request.outputs.irb_number }}
          DURATION: ${{ needs.parse-request.outputs.expected_duration }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Build Azure Portal URLs
          PORTAL_BASE="https://portal.azure.com/#@/resource"
          RG_URL="https://portal.azure.com/#browse/resourcegroups/overview/${RG}"
          VM_URL="${PORTAL_BASE}/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}/providers/Microsoft.Compute/virtualMachines/${VM_NAME}/overview"
          STORAGE_URL="${PORTAL_BASE}/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}/providers/Microsoft.Storage/storageAccounts/${STORAGE_ACCOUNT}/overview"

          if [ "$REQUEST_TYPE" == "standard_research" ]; then
            echo "========================================" > /tmp/message.txt
            echo "SUCCESS: Standard Research Environment Ready!" >> /tmp/message.txt
            echo "========================================" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "PROJECT DETAILS:" >> /tmp/message.txt
            echo "- Project Name: $PROJECT" >> /tmp/message.txt
            echo "- Workload Types: $WORKLOADS" >> /tmp/message.txt
            echo "- Cost Center: $COST_CENTER" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "RESOURCES CREATED:" >> /tmp/message.txt
            echo "- Resource Group: $RG" >> /tmp/message.txt
            echo "- Virtual Machine: $VM_NAME" >> /tmp/message.txt
            echo "- Storage Account: $STORAGE_ACCOUNT" >> /tmp/message.txt
            echo "- Public IP: $PUBLIC_IP" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "AZURE PORTAL LINKS:" >> /tmp/message.txt
            echo "- Resource Group: https://portal.azure.com/#@/resource/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}/overview" >> /tmp/message.txt
            echo "- Virtual Machine: https://portal.azure.com/#@/resource/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}/providers/Microsoft.Compute/virtualMachines/${VM_NAME}/overview" >> /tmp/message.txt
            echo "- Storage Account: https://portal.azure.com/#@/resource/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}/providers/Microsoft.Storage/storageAccounts/${STORAGE_ACCOUNT}/overview" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "CONNECTION INSTRUCTIONS:" >> /tmp/message.txt
            echo "- SSH: ssh researcher@$PUBLIC_IP" >> /tmp/message.txt
            echo "- Connection details sent to: $PI" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "COST INFORMATION:" >> /tmp/message.txt
            echo "- Estimated Monthly Cost: 350-650 USD" >> /tmp/message.txt
            echo "- Cost Center: $COST_CENTER" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "GitHub Actions Workflow: $WORKFLOW_URL" >> /tmp/message.txt
          else
            echo "========================================" > /tmp/message.txt
            echo "SUCCESS: Secure PHI Environment (AVE) Ready!" >> /tmp/message.txt
            echo "========================================" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "HIPAA-compliant environment provisioned successfully." >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "PROJECT DETAILS:" >> /tmp/message.txt
            echo "- Project Name: $PROJECT" >> /tmp/message.txt
            echo "- IRB Number: $IRB" >> /tmp/message.txt
            echo "- Duration: $DURATION" >> /tmp/message.txt
            echo "- Cost Center: $COST_CENTER" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "RESOURCES CREATED:" >> /tmp/message.txt
            echo "- Resource Group: $RG" >> /tmp/message.txt
            echo "- Virtual Machine: $VM_NAME" >> /tmp/message.txt
            echo "- Storage Account: $STORAGE_ACCOUNT (HIPAA-compliant)" >> /tmp/message.txt
            echo "- Azure Key Vault: Encryption keys" >> /tmp/message.txt
            echo "- Log Analytics: Audit logging" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "AZURE PORTAL LINKS:" >> /tmp/message.txt
            echo "- Resource Group: https://portal.azure.com/#@/resource/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}/overview" >> /tmp/message.txt
            echo "- Virtual Machine: https://portal.azure.com/#@/resource/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}/providers/Microsoft.Compute/virtualMachines/${VM_NAME}/overview" >> /tmp/message.txt
            echo "- Storage Account: https://portal.azure.com/#@/resource/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG}/providers/Microsoft.Storage/storageAccounts/${STORAGE_ACCOUNT}/overview" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "SECURITY FEATURES ENABLED:" >> /tmp/message.txt
            echo "- Network isolation (no public IP)" >> /tmp/message.txt
            echo "- Encryption at rest (Customer-managed key)" >> /tmp/message.txt
            echo "- Encryption in transit (TLS 1.2)" >> /tmp/message.txt
            echo "- Audit logging (Log Analytics)" >> /tmp/message.txt
            echo "- HIPAA/HITRUST policy applied" >> /tmp/message.txt
            echo "- Azure Bastion for secure access" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "ACCESS INSTRUCTIONS:" >> /tmp/message.txt
            echo "- Access via Azure Bastion only (no direct public access)" >> /tmp/message.txt
            echo "- Connection details sent to: $PI" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "COST INFORMATION:" >> /tmp/message.txt
            echo "- Estimated Monthly Cost: 4200-8500 USD" >> /tmp/message.txt
            echo "- Cost Center: $COST_CENTER" >> /tmp/message.txt
            echo "" >> /tmp/message.txt
            echo "GitHub Actions Workflow: $WORKFLOW_URL" >> /tmp/message.txt
          fi

      - name: Update ServiceNow - Close Ticket as Complete
        env:
          SNOW_INSTANCE: ${{ secrets.SERVICENOW_INSTANCE }}
          SNOW_USER: ${{ secrets.SERVICENOW_USER }}
          SNOW_PASS: ${{ secrets.SERVICENOW_PASSWORD }}
          TICKET: ${{ needs.parse-request.outputs.ticket_number }}
        run: |
          if [ -z "$SNOW_INSTANCE" ]; then
            echo "ServiceNow credentials not configured - skipping update"
            exit 0
          fi

          echo "Looking up ticket: $TICKET"

          # Step 1: Get the sys_id of the ticket
          RESPONSE=$(curl -s -X GET \
            -u "$SNOW_USER:$SNOW_PASS" \
            -H "Accept: application/json" \
            "https://$SNOW_INSTANCE.service-now.com/api/now/table/sc_req_item?sysparm_query=number=$TICKET&sysparm_fields=sys_id,number,state")

          echo "Lookup response: $RESPONSE"

          SYS_ID=$(echo "$RESPONSE" | jq -r '.result[0].sys_id')

          if [ -z "$SYS_ID" ] || [ "$SYS_ID" == "null" ]; then
            echo "Could not find ticket $TICKET"
            exit 0
          fi

          echo "Found ticket sys_id: $SYS_ID"

          # Step 2: Read the success message and escape it for JSON
          MSG_ESCAPED=$(cat /tmp/message.txt | jq -Rs .)

          # Step 3: Build JSON payload properly
          JSON_PAYLOAD=$(jq -n \
            --arg state "3" \
            --arg close_notes "Environment provisioned successfully via GitHub Actions." \
            --argjson work_notes "$MSG_ESCAPED" \
            '{state: $state, close_notes: $close_notes, work_notes: $work_notes}')

          echo "Payload: $JSON_PAYLOAD"

          # Step 4: Update the ticket - Close Complete (state=3) with work notes
          UPDATE_RESPONSE=$(curl -s -X PATCH \
            -u "$SNOW_USER:$SNOW_PASS" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://$SNOW_INSTANCE.service-now.com/api/now/table/sc_req_item/$SYS_ID")

          echo "Update response: $UPDATE_RESPONSE"
          echo "Ticket $TICKET closed successfully!"

  # ============================================
  # JOB 5: Update ServiceNow - Failure
  # ============================================
  notify-failure:
    name: Notify Failure
    needs: [parse-request, provision]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Update ServiceNow - Mark as Failed
        env:
          REQUEST_TYPE: ${{ needs.parse-request.outputs.request_type }}
          PROJECT: ${{ needs.parse-request.outputs.project_name }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SNOW_INSTANCE: ${{ secrets.SERVICENOW_INSTANCE }}
          SNOW_USER: ${{ secrets.SERVICENOW_USER }}
          SNOW_PASS: ${{ secrets.SERVICENOW_PASSWORD }}
          TICKET: ${{ needs.parse-request.outputs.ticket_number }}
        run: |
          if [ -z "$SNOW_INSTANCE" ]; then
            echo "ServiceNow credentials not configured - skipping update"
            exit 0
          fi

          # Build failure message
          echo "FAILED: Provisioning Failed" > /tmp/message.txt
          echo "" >> /tmp/message.txt
          echo "Request Type: $REQUEST_TYPE" >> /tmp/message.txt
          echo "Project: $PROJECT" >> /tmp/message.txt
          echo "" >> /tmp/message.txt
          echo "The automated provisioning encountered an error." >> /tmp/message.txt
          echo "" >> /tmp/message.txt
          echo "Please review the GitHub Actions logs for details:" >> /tmp/message.txt
          echo "$WORKFLOW_URL" >> /tmp/message.txt
          echo "" >> /tmp/message.txt
          echo "Next Steps:" >> /tmp/message.txt
          echo "1. Review the error logs in GitHub Actions" >> /tmp/message.txt
          echo "2. Contact the Cloud Team for assistance" >> /tmp/message.txt
          echo "3. Re-submit the request once the issue is resolved" >> /tmp/message.txt

          echo "Looking up ticket: $TICKET"

          # Step 1: Get the sys_id of the ticket
          RESPONSE=$(curl -s -X GET \
            -u "$SNOW_USER:$SNOW_PASS" \
            -H "Accept: application/json" \
            "https://$SNOW_INSTANCE.service-now.com/api/now/table/sc_req_item?sysparm_query=number=$TICKET&sysparm_fields=sys_id,number,state")

          SYS_ID=$(echo "$RESPONSE" | jq -r '.result[0].sys_id')

          if [ -z "$SYS_ID" ] || [ "$SYS_ID" == "null" ]; then
            echo "Could not find ticket $TICKET"
            exit 0
          fi

          echo "Found ticket sys_id: $SYS_ID"

          # Step 2: Read the failure message and escape it for JSON
          MSG_ESCAPED=$(cat /tmp/message.txt | jq -Rs .)

          # Step 3: Build JSON payload properly
          JSON_PAYLOAD=$(jq -n \
            --arg state "4" \
            --arg close_notes "Provisioning failed - see work notes for details." \
            --argjson work_notes "$MSG_ESCAPED" \
            '{state: $state, close_notes: $close_notes, work_notes: $work_notes}')

          echo "Payload: $JSON_PAYLOAD"

          # Step 4: Update the ticket - Closed Incomplete (state=4) with work notes
          UPDATE_RESPONSE=$(curl -s -X PATCH \
            -u "$SNOW_USER:$SNOW_PASS" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://$SNOW_INSTANCE.service-now.com/api/now/table/sc_req_item/$SYS_ID")

          echo "Update response: $UPDATE_RESPONSE"
          echo "Ticket $TICKET marked as failed."
